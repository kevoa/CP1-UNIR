# Dockerfile.agent (Haciendo que el usuario 'jenkins' tenga UID 0)
FROM jenkins/ssh-agent:jdk17

USER root

# Paso 1: Actualizar e instalar Python, pytest y prerrequisitos generales
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
        python3 \
        python3-pip \
        python3-pytest \
        ca-certificates \
        curl \
        gnupg \
        lsb-release && \
    rm -rf /var/lib/apt/lists/*

# Paso 2: Configurar el repositorio de Docker e instalar Docker CLI y Docker Compose Plugin
RUN install -m 0755 -d /etc/apt/keyrings && \
    curl -fsSL https://download.docker.com/linux/debian/gpg -o /etc/apt/keyrings/docker.asc && \
    chmod a+r /etc/apt/keyrings/docker.asc && \
    echo \
      "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/debian \
      $(lsb_release -cs) stable" | \
      tee /etc/apt/sources.list.d/docker.list > /dev/null && \
    apt-get update && \
    apt-get install -y --no-install-recommends \
        docker-ce-cli \
        docker-compose-plugin && \
    rm -rf /var/lib/apt/lists/*

# Paso 3: Modificar el usuario 'jenkins' para que tenga UID 0 (root)
# El usuario 'jenkins' ya existe en la imagen base.
# -o permite UID no único (aunque en este caso lo hacemos único como root)
RUN echo "Modificando usuario 'jenkins' para que tenga UID 0 (root)..." && \
    usermod -u 0 -o jenkins && \
    echo "Modificando grupo primario de 'jenkins' para que tenga GID 0 (root)..." && \
    groupmod -g 0 -o jenkins && \
    # Asegurar que el home directory siga perteneciendo al "nuevo" jenkins (ahora root)
    # Esto podría no ser estrictamente necesario si el home ya es accesible por root,
    # pero es una buena medida.
    chown -R jenkins:jenkins /home/jenkins

# No es necesario añadir 'jenkins' al grupo 'docker' si 'jenkins' ahora ES root.
# No es necesario instalar 'sudo' ni modificar 'sudoers'.

# La imagen base 'jenkins/ssh-agent' está configurada para que el
# servicio SSH se ejecute y acepte conexiones para el usuario 'jenkins'.
# Ahora, ese usuario 'jenkins' será UID 0.